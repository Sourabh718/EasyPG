<%- include('../partials/head') %>
</head>
<style>
    .name-favourite{
        display: flex;
        justify-content: space-between;
    }
    .card{
        transition: transform 0.2s;
    }
    .card:hover {
    transform: translateY(-5px);
    }
    .containers {
        display: flex;
        gap: 20px;
    }
    .size{
        width: 80%;
        display: flex;
        flex-wrap: wrap;
        margin: auto
    }
</style>
<body>
    <%- include('../partials/nav') %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <div class="containers">
    <main class="container my-5 width">
        <%- include('../partials/sidebar') %>
        <div class="row g-4 bg-green-100 p-4 rounded-4 shadow-lg size">
        <h2 class="text-center text-danger mb-4 fw-bold">Explore Our Registered Homes</h2>
        
            <% registeredHomes.forEach(home => { %>
            <div class="col-md-4 col-sm-6">
                <div class="card shadow-lg border-0 rounded-4 h-100 card">
                    <img src="/<%= home.photoUrl %>" alt="<%= home.houseName %>" class="card-img-top" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <div class="name-favourite">
                            <h5 class="card-title text-primary"><%= home.houseName %></h5>
                            <% const isFav = favouriteHomes.some(fav => fav._id.toString() === home._id.toString()); %>
                                <button 
                                class="fav-toggle btn btn-link p-0 border-0 bg-transparent"
                                data-id="<%= home._id %>"
                                data-fav="<%= isFav ? 'true' : 'false' %>"
                            >
                                <% if(isFav) { %>
                                <i class="fa-solid fa-heart text-danger"></i>
                                <% } else { %>
                                <i class="fa-regular fa-heart"></i>
                                <% } %>
                            </button>
                        </div>
                        <p class="text-muted mb-2"><i class="bi bi-geo-alt-fill"></i> <%= home.location %></p>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-danger fw-bold">₹<%= home.price %> / Month</span>
                            <span class="text-warning fw-bold">★<%= home.rating %></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="/user/home-booking/payment/<%=home._id%>" class="btn btn-success btn-sm">Book</a>
                            
                            <a href="/user/home/details/<%=home._id%>" class="btn btn-info btn-sm text-white">Details</a>
                        </div>
                    </div>
                </div>
            </div>
            <% }) %>
        </div>
    </main>
    </div>
    <%- include('../partials/footer') %>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".fav-toggle").forEach(button => {
        button.addEventListener("click", async () => {
        const homeId = button.dataset.id;
        const isFav = button.dataset.fav === "true";
        console.log("Toggling favourite for home ID:", homeId, "Current state:", isFav);

        try {
            if (isFav) {
            const res = await fetch(`/user/remove-favourite/${homeId}`, {
                method: "POST",
                headers: { "Accept": "application/json" }
            });
            const data = await res.json();
            if (data.success) {
                button.dataset.fav = "false";
                button.innerHTML = '<i class="fa-regular fa-heart"></i>';
            }
            } else {
            const res = await fetch(`/user/watchlist`, {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "Accept": "application/json" 
                },
                body: JSON.stringify({ favouriteId: homeId })
                });
            const data = await res.json();
            if (data.success) {
                button.dataset.fav = "true";
                button.innerHTML = '<i class="fa-solid fa-heart text-danger"></i>';
            }
            }
        } catch (err) {
            console.error("Error toggling favourite:", err);
        }
        });
    });
    });
    </script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
